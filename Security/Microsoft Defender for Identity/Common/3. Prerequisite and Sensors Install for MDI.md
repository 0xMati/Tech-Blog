# Preparing Your Environment for Microsoft Defender for Identity, and Sensors Install
üóìÔ∏è Published: 2025-07-13

In this guide, we‚Äôll cover everything you need to do **before** you install your first Defender for Identity sensor: from licensing and network rules to server specs, audit policies, service accounts, and getting your Azure workspace ready.

---

## 1. Licensing & Azure Roles

Make sure you‚Äôve got the right licenses and Azure permissions:

- **Required licenses** (one of):  
  - Enterprise Mobility + Security E5 (EMS E5/A5)  
  - Microsoft 365 E5/A5/G5  
  - Microsoft 365 E5/A5/G5/F5 Security  
  - Microsoft 365 F5 Security + Compliance  
  - Or a standalone Defender for Identity license

- **Azure role**: You need a Microsoft Entra ID tenant and one of:  
  - A user with the **Security administrator** role  
  - Or Unified RBAC permissions: System settings (Read & manage) + Security setting (All)

---

## 2. Network & Firewall Requirements

Your sensor servers must reach the Defender for Identity cloud service and your DCs/AD FS/AD CS servers must talk to each other:

1. **Cloud endpoints** (outbound HTTPS):  
   - `https://*.sensorapi.atp.azure.com`  
   - `crl.microsoft.com`  
   - `ctldl.windowsupdate.com`  
   - `www.microsoft.com/pkiops/`  
   - `www.microsoft.com/pki/` 

2. **On-prem ports from AD sensors to domain members:**  
   - **TCP 135** ‚Äì RPC endpoint mapper (needed for queries and event-log access)  
   - **TCP 445** ‚Äì SMB (remote registry, event‚Äêlog access)  
   - **UDP 137** ‚Äì NetBIOS name resolution
   - **TCP 3389** ‚Äì RDP (optional: health checks or manual troubleshooting)
   **On-prem ports from sensors to Radius Servers**:  
   - **UDP 1813** ‚Äì RADIUS accounting on your NPS/RADIUS servers  
   **On-prem ports from sensors to DNS Servers**:
   - **UDP/TCP 53** ‚Äì DNS resolution to your DNS servers 

---

## 3. Windows & Server Specifications

Sensor prerequisites differ slightly by deployment type:

| Component                 | Requirement                                                                                   |
|---------------------------|-----------------------------------------------------------------------------------------------|
| **Operating System**      | Windows Server 2019 or later **with March 2024 CU** (DCs, AD FS/AD CS/Entra Connect servers) |
| **CPU & RAM**             | ‚â• 2 cores (no hyper-threading), ‚â• 6 GB RAM                                                     |
| **Disk**                  | ‚â• 10 GB free (‚â• 5 GB for **standalone sensors**) |
| **Network throughput**    | Up to 100 000 pkts/sec per sensor                                                              |
| **Power plan**            | **High Performance** (for best sensor performance) |
| **Time sync**             | All servers within **5 minutes** of each other                                                |

---

## 3. Audit Configuration

Defender for Identity relies heavily on Windows Security logs and ACL-based auditing in AD. In this step, we‚Äôll make sure your GPOs are configured correctly.

### 3.1 GPO Audit Settings

#### A. ‚ÄúDC audit settings‚Äù GPO  
Apply to all Domain Controllers and any RODCs. Under  
`Computer Configuration ‚Üí Policies ‚Üí Windows Settings ‚Üí Security Settings ‚Üí Local Policies ‚Üí Security Options`  
- **Network security: Restrict NTLM: Audit NTLM authentication in this domain** ‚Üí **Enable all**

#### B. ‚ÄúDC audit settings‚Äù & ‚ÄúServers audit settings‚Äù GPOs  
Apply to all Domain Controllers and member servers that host AD roles (AD FS, AD CS, Entra Connect):

1. **NTLM traffic auditing**  
   - **Network security: Restrict NTLM: Outgoing NTLM traffic to remote servers** ‚Üí **Audit all**  
   - **Network security: Restrict NTLM: Audit incoming NTLM traffic** ‚Üí **Enable auditing for all accounts**

2. **Certificate Services auditing** (for AD CS servers)  
   `Computer Configuration ‚Üí Policies ‚Üí Windows Settings ‚Üí Security Settings ‚Üí Advanced Audit Policy Configuration ‚Üí Audit Policies ‚Üí Object Access ‚Üí Audit Certification Services`  
   - **Configure** to audit both **Success** and **Failure** events

#### D. Audit Application-Generated Events for ADFS 
Apply to all AD FS servers. Under  
`Computer Configuration ‚Üí Policies ‚Üí Windows Settings ‚Üí Security Settings ‚Üí Advanced Audit Policy Configuration ‚Üí Audit Policies ‚Üí Object Access ‚Üí Audit Application Generated`  
- **Configure** to audit both **Success** and **Failure** events

---

### 3.2 Set SACLs on the Domain Partition

To capture object‚Äêlevel changes (event 4662) for users, groups, computers, gMSAs and MSAs, you need to enable auditing on the domain naming context:

1. **Open Active Directory Users and Computers**  
2. **Right-click your domain** (e.g. `contoso.com`) ‚Üí **Properties** ‚Üí **Security** ‚Üí **Advanced**  
3. Switch to the **Auditing** tab and click **Add**  
4. In the **Auditing Entry** dialog:  
   - **Principal:** Everyone  
   - **Type:** Success  
   - **Applies to:** Descendant User objects  
5. Under **Permissions**, click **Clear all**, then:  
   - Check **Full control** (this selects every permission)  
   - Uncheck **List contents**, **Read all properties**, **Read permissions**  
   - Click **OK**  
6. Back in the **Advanced Security Settings** window, repeat steps 3‚Äì5 for each of these **‚ÄúApplies to‚Äù** scopes:  
   - Descendant **Group** objects  
   - Descendant **Computer** objects  
   - Descendant **msDS-GroupManagedServiceAccount** objects  
   - Descendant **msDS-ManagedServiceAccount** objects  
7. Click **OK** to close all dialogs and replicate to other DCs  

Once complete, look for **4662** (‚ÄúAn operation was performed on an object‚Äù) events targeting these object classes in the Security log‚Äîthese will now be ingested by Defender for Identity.  

---

### 3.3 Set SACLs on the Configuration Partition

Enable auditing on your AD Configuration partition to capture creation, modification and deletion of configuration objects (events 4662):

1. **Open ADSI Edit** (`adsiedit.msc`) and connect to the **Configuration** naming context.  
2. **Right-click** the **Configuration** container ‚Üí **Properties** ‚Üí **Security** ‚Üí **Advanced**.  
3. Switch to the **Auditing** tab and click **Add**.  
4. In the **Auditing Entry** dialog:  
   - **Principal:** Everyone  
   - **Type:** Success  
   - **Applies to:** This object and all descendant objects  
5. Under **Permissions**, click **Clear all**, then scroll up and check **Write all properties**.  
6. Click **OK** to save and close all dialogs.  

This ensures any write operation on configuration objects is audited and forwarded to Defender for Identity .  

---

#### 3.4 Set SACLs on the AD FS Container

Enable auditing on your AD FS configuration objects in AD:

1. **Open Active Directory Users and Computers** and navigate to the **CN=ADFS,CN=Microsoft,CN=Program Data,DC=yourDomain,DC=com** container.  
2. **Right-click** the container ‚Üí **Properties** ‚Üí **Security** ‚Üí **Advanced**.  
3. Go to the **Auditing** tab and click **Add**.  
4. In the **Auditing Entry** dialog:  
   - **Principal:** Everyone  
   - **Type:** All  
   - **Applies to:** This object and all descendant objects  
5. Under **Permissions**, click **Clear all**, then scroll up and check:  
   - **Read all properties**  
   - **Write all properties**  
6. Click **OK**, then **Apply** to save the ACL change.

Now any read or write operation on AD FS objects will generate audit events that Defender for Identity can ingest.   

---

#### 3.5 Enable Certification Authority Auditing

Capture all CA operations (issuance, revocation, config changes) by enabling CA auditing either via the GUI or PowerShell:

**A. GUI Method**  
1. Open the **Certification Authority** snap-in for your CA.  
2. Right-click your CA name ‚Üí **Properties** ‚Üí **Auditing** tab.  
3. Check **all** available audit events (e.g., backup/restore, config changes, requests, revocations, key archival, service start/stop).  
4. Click **OK**.  

> *Note: You may need to restart the **Active Directory Certificate Services** service for settings to take effect.*

**B. CLI Method**  
Run this on the CA server (or remotely via PowerShell remoting):  
```powershell
# Enable all audit categories (0x7F = all bits) and restart the CA service
certutil -setreg "CA\AuditFilter" 0x7F
Restart-Service certsvc -Verbose
```

---

## 4. Create Directory Service Account & Universal Groups

Before you install any sensors, you need a managed service account (gMSA) for the sensors to run under, plus two universal AD groups:

1. **MDI-Sensor-Computers** ‚Äì contains all servers that will host MDI sensors  
2. **MDI-ServiceAccounts** ‚Äì contains the gMSA itself (so you can grant rights to the group instead of the account)

---

### 4.1 Create the ‚ÄúSensor Computers‚Äù group

On any domain-joined management workstation, open an elevated PowerShell prompt and run:

```powershell
New-ADGroup `
  -Name "MDI-Sensor-Computers" `
  -GroupScope Universal `
  -Path "OU=Security,DC=contoso,DC=com" `
  -Description "Servers authorized to run MDI sensors"
```
### 4.2 Add your DCs/AD-role servers to that group

```powershell
# Adjust names for your environment
$SensorGroup = Get-ADGroup "MDI-Sensor-Computers"
$Servers = Get-ADComputer -Filter "Name -in 'DC1','DC2','ADFS1','ADCS1','Sync1'"
Add-ADGroupMember -Identity $SensorGroup -Members $Servers
```
Wait a few minutes for AD replication, then restart each server so they pick up their new group membership.

### 4.3 Create the gMSA for Defender for Identity

```powershell
New-ADServiceAccount `
  -Name "MDI-DSA" `
  -DNSHostName "MDI-DSA@contoso.com" `
  -PrincipalsAllowedToRetrieveManagedPassword "MDI-Sensor-Computers" `
  -Description "Managed service account for MDI sensors"
```

### 4.4 Verify the gMSA can be retrieved by your sensor hosts

```powershell
Invoke-Command -ComputerName DC1,DC2,ADFS1,ADCS1,Sync1 `
  -ScriptBlock {
    klist purge -li 0x3e7
    Test-ADServiceAccount "MDI-DSA"
  }
```
A return value of True means the hosts can successfully retrieve the gMSA password.

### 4.5 Create the ‚ÄúService Accounts‚Äù group and add the gMSA

```powershell
New-ADGroup `
  -Name "MDI-ServiceAccounts" `
  -GroupScope Universal `
  -Path "OU=Security,DC=contoso,DC=com" `
  -Description "Group for MDI service accounts"

Add-ADGroupMember `
  -Identity "MDI-ServiceAccounts" `
  -Members "MDI-DSA$"
```
Now you can grant rights (Log on as a service, ACLs, etc.) to MDI-ServiceAccounts rather than individual accounts.

---

## 5. Delegate ‚ÄúDeleted Objects‚Äù Read Access

Defender for Identity needs to read tombstone metadata from the AD ‚ÄúDeleted Objects‚Äù container. Grant ‚ÄúList Contents‚Äù & ‚ÄúRead Property‚Äù to your service-account group on each domain:

```powershell
# Variables ‚Äì adjust to your domains and group name
$Group     = "MDI-ServiceAccounts"
$Container = "CN=Deleted Objects,DC=contoso,DC=com"

# 1. Take ownership (required once per domain)
dsacls.exe "$Container" /takeownership

# 2. Grant List and Read to the group
dsacls.exe "$Container" /G "contoso\$Group:LCRP"
```
Repeat these two commands for each AD domain partition (e.g. DC=child,DC=contoso,DC=com, etc.).

> Note: You can remove the delegation later with:
dsacls.exe "$Container" /R "yourDomain\$Group"

> This ensures that when objects are deleted, your MDI sensors can enumerate them and ingest the resulting 4742/4662 events.

---

## 6. Verify Managed Service Account Permissions

Before you install any sensors, make sure your gMSA (`MDI-DSA`) really has all the rights it needs.

1. **Install the Defender for Identity PowerShell Module**  
   On your management workstation and on each DC, run:
```powershell
   Install-Module -Name DefenderForIdentity -Force
```

2. **Prepare Credentials (if needed)**
If your current user isn‚Äôt a Domain or Enterprise Admin, store a high-privilege account in a variable:
```powershell
$creds = Get-Credential    # enter a Domain Admin or equivalent
```

3. **Run the Test-MDIDSA Cmdlet**
```powershell
Invoke-Command -ComputerName contosodc1.contoso.com `
  -ScriptBlock { Test-MDIDSA -Identity "MDI-DSA" -Detailed } `
  -Credential $creds
```
You should see True for each test (SensitiveGroupsMembership, ExplicitDelegation, DeletedObjectsContainerPermission, PasswordRetrieval).

4. **(Optional) Test as a Privileged User**
If you‚Äôre already running as a built-in Admin in the admin forest, you can omit -Credential:
```powershell
Invoke-Command -ComputerName contosodc1.contoso.com `
  -ScriptBlock { Test-MDIDSA -Identity "MDI-DSA" -Detailed }
```
A successful run confirms your gMSA can read deleted-object tombstones, enumerate groups, retrieve its password, and has any explicit ACL delegations required.

---

## 7. Grant Rights to the DSA Account

Your gMSA (‚ÄúMDI-DSA‚Äù) needs three specific rights on each sensor host. We‚Äôll do this via a GPO called **MDI-Config** linked to the OU containing your sensor servers.

### 7.1 Find the gMSA‚Äôs SID

On any domain-joined machine with RSAT tools:

```powershell
$msa = Get-ADServiceAccount -Identity "MDI-DSA"
$msa.SID.Value
# e.g. S-1-5-21-1111111111-2222222222-3333333333-4444
```
Save that SID for the log-access policy below.

### 7.2 ‚ÄúLog on as a service‚Äù
In the MDI-Config GPO (Computer Configuration ‚Üí Policies ‚Üí Windows Settings ‚Üí Security Settings ‚Üí Local Policies ‚Üí User Rights Assignment):

Log on as a service ‚Üí Add:
CONTOSO\MDI-DSA
BUILTIN\Administrators
NT SERVICE\ALL SERVICES

### 7.3 SAM remote calls
Still in MDI-Config (Computer Configuration ‚Üí Policies ‚Üí Windows Settings ‚Üí Security Settings ‚Üí Local Policies ‚Üí Security Options):

Network access: Restrict clients allowed to make remote calls to SAM
Click Define this policy setting ‚Üí Edit Security ‚Üí Add
Object Types ‚Üí check Service Accounts ‚Üí OK
Enter MDI-DSA ‚Üí Check Names ‚Üí OK ‚Üí Apply
This lets the sensor‚Äôs gMSA remotely query SAM on DCs.

### 7.4 Event Log ‚ÄúLog Access‚Äù
In MDI-Config (Computer Configuration ‚Üí Policies ‚Üí Administrative Templates ‚Üí Windows Components ‚Üí Event Log Service ‚Üí Security):

Configure log access ‚Üí Enabled
In the Log Access box, paste:

(A;;0x1;;;S-1-5-21-1111111111-2222222222-3333333333-4444)

(replace with your gMSA‚Äôs SID)
> This ensures the gMSA can read the Security event log.

After applying this GPO, gpupdate /force on each sensor host, then reboot to pick up the new rights.
With these in place, your gMSA has the minimum rights it needs to run the Defender for Identity sensor.

---

## 8. Create the Defender for Identity Workspace in Azure

Now that your on-prem is ready, let‚Äôs provision the Defender for Identity instance in your Azure tenant (contoso.com).

1. **Sign in to Microsoft Defender**  
   - Use an account with the **Security administrator** role (e.g. `securityadmin@contoso.com`).  
   - Go to **Settings** ‚Üí **Identities** (or navigate directly to `https://security.microsoft.com/settings/identities`).  

2. **Provision the workspace**  
   - On first visit, Defender will auto-provision your Identity workspace because you have a qualifying license (e.g. Microsoft 365 E5).  
   - You‚Äôll see a ‚ÄúHang on‚Ä¶ preparing your Defender for Identity workspace‚Äù message. This takes a few minutes.

3. **Verify Sensors blade**  
   - Once provisioning completes, the portal automatically opens **Sensors** under **Defender for Identity**.  
   - It will show **0 items** until you deploy your first sensor, confirming your workspace is ready.

---

## 9. Download & Deploy the Sensor

Now that your workspace and service accounts are ready, let‚Äôs grab the sensor installer and put it on your first Domain Controller (e.g. `contosodc1.contoso.com`).

### 9.1 Download the Installer

1. **Sign in** to the Microsoft Defender portal (`https://security.microsoft.com`) as your Security Admin (e.g. `securityadmin@contoso.com`).  
2. Go to **Settings** ‚Üí **Identities** ‚Üí **Sensors** ‚Üí **Add sensor**.  
3. On the **Add a new sensor** blade:  
   - Click the **Copy** icon next to the **Access Key** and paste it into Notepad.  
   - Click **Download installer** to get `Azure ATP Sensor Setup.zip`.  

> If your browser blocks pop-ups, allow them for `security.microsoft.com` and retry the download.

### 9.2 GUI Installation

1. **Extract** the ZIP to `C:\Temp\AzureATPSensor`.  
2. **Run** `Azure ATP Sensor Setup.exe`.  
3. **Select** your language (e.g. English) and click **Next**.  
4. On **Sensor deployment type**, click **Next**.  
5. On **Configure the sensor**, leave the default install path and **paste** your Access Key, then click **Install**.  
6. When it finishes, click **Finish**.  
7. Back in the Defender portal under **Sensors**, wait a few minutes for `contosodc1.contoso.com` to appear with status **Not configured**.  
8. Click your sensor, choose **Manage sensor**, give it a friendly name (e.g. ‚ÄúContoso DC1 Sensor‚Äù), click **Save**, then close.  
9. Within moments the status will switch from **Not configured** ‚Üí **Syncing** ‚Üí **Up to date**.

### 9.3 Silent Installation (for Server Core / Automation)

On a sensor host (e.g. `contosodc2.contoso.com`) open an **elevated PowerShell** prompt:

```powershell
cd C:\Temp\AzureATPSensor
.\AzureATP Sensor Setup.exe /quiet NetFrameworkCommandLineArguments="/q" AccessKey="<your-access-key>"
```
Wait a few minutes, then verify in the portal that contosodc2.contoso.com is Up to date.

### 9.4 Uninstalling the Sensor

- Silent uninstall (Server Core or automation):
```powershell
cd C:\Temp\AzureATPSensor
.\AzureATP Sensor Setup.exe /quiet /Uninstall
```

- GUI uninstall (full desktop):
Run Azure ATP Sensor Setup.exe ‚Üí Uninstall.

### 9.5 Sensor Install/Uninstall Logs

```powershell
dir $env:LOCALAPPDATA\Temp\*Sensor*
```
Look for files like AzureAdvancedThreatProtection_Sensor_*.log or SensorDeployment_*.log for troubleshooting.

---

## 10. Check the MDI Configuration

Once your sensors are deployed, validate the entire setup with Microsoft‚Äôs readiness script.

1. **Download the Test-MDIReadiness.ps1 script**  
   Grab it from the official GitHub repo:  
   `https://github.com/microsoft/Microsoft-Defender-for-Identity/blob/main/Test-MdiReadiness/Test-MdiReadiness.ps1`  
   (or click **Raw** to save it as `C:\Tools\Test-MDIReadiness.ps1`)

2. **Run the script**  
   On your management host (e.g. `contosoadmin.contoso.com`), open an elevated PowerShell prompt and execute:  
   ```powershell
   C:\Tools\Test-MDIReadiness.ps1
   ```

The script will check licensing, network connectivity, GPOs, ACLs, gMSA permissions, and sensor health.

3. **Review results**
Ensure every test returns Pass. Any Fail entries will include remediation guidance.


