# Weak supported encryption algorithms on DCs 
üóìÔ∏è Published: 2025-05-05


This article is based on The January 2025 Cumulative update for server 2016 and newer has added new fields to 4768 and 4769 events on Domain Controllers. 
it added new and very helpful fields to 4768 and 4769 events.
Below are examples of the updated events along with tables which describe key fields.  The enhancements now make it possible to centrally identify:

The session key type of both TGTs and Service Tickets.
The eTypes the Kerberos client advertised it can support in the AS-REQ and TGS-REQ packets.  Use this information to identify any device (or keytab) that is not able to support AES
The available keys for the accounts involved.  Use this information to identify accounts that require a password reset in order to support AES.

- Example for 4768 :

![](assets/Weak%20supported%20encryption%20algorithms%20on%20DCs/2025-05-05-21-35-56.png)

| **Section**             | **Field**                            | **Description**                                                                                                                                    |
| ----------------------- | ------------------------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Account Information** | `Account Name`                       | The account requesting the TGT (user or computer account).                                                                                         |
|                         | `MSDS-SupportedEncryptionTypes`      | If not set on the account, the **DefaultDomainSupportedEncTypes** value on the **authenticating DC** will be used.                                 |
|                         | `Available Keys`                     | If AES-SHA1 is not listed here, the account‚Äôs password has likely **not been changed since AES support was introduced** in the domain.             |
| **Service Information** | `Service Name`                       | For TGT requests, this is always `krbtgt`.                                                                                                         |
|                         | `MSDS-SupportedEncryptionTypes`      | Determined by the **domain**, not the attribute on the krbtgt object.                                                                              |
|                         | `Available Keys`                     | Same logic as above: missing AES-SHA1 here means the **krbtgt password hasn‚Äôt been reset since AES was enabled**.                                  |
| **Network Information** | `Client Address`                     | IP address of the Kerberos client requesting the TGT.                                                                                              |
|                         | `Advertized Etypes`                  | The encryption types the client claims it **supports** in the AS-REQ. This is key to detecting RC4-dependent clients.                              |
| **Additional Info**     | `Error Code`                         | `0x0` indicates success. Other values indicate failure; refer to Microsoft‚Äôs list of Kerberos error codes.                                         |
|                         | `Ticket Encryption Type`             | **Prior to Jan 2025:** showed the encryption of the session key. <br> **After Jan 2025:** shows the encryption of the **TGT itself** (KDC to KDC). |
|                         | `Session Encryption Type`            | Encryption used for the **session key shared with the client**. This value **must match what the client supports** (based on `Advertized Etypes`). |
|                         | `Pre-Authentication Encryption Type` | Indicates which encryption type was used for pre-auth (if required). Should match the **strongest advertised encryption** by the client.           |


- Example for 4769 :

![](assets/Weak%20supported%20encryption%20algorithms%20on%20DCs/2025-05-05-21-36-33.png)

| **Section**             | **Field**                       | **Description**                                                                                                                                               |
| ----------------------- | ------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Account Information** | `Account Name`                  | The account requesting the **Service Ticket** (TGS-REQ).                                                                                                      |
|                         | `MSDS-SupportedEncryptionTypes` | N/A ‚Äì The value on the **requesting account** does **not influence** the encryption type used in the service ticket.                                          |
| **Service Information** | `Service Name`                  | The **target account** of the ticket request (usually a service with an SPN).                                                                                 |
|                         | `MSDS-SupportedEncryptionTypes` | The **KDC selects the strongest encryption** supported by the target account‚Äôs configured values.                                                             |
|                         | `Available Keys`                | If **AES-SHA1 is missing**, the service account‚Äôs password has not been changed since AES support was introduced.                                             |
| **Network Information** | `Client Address`                | IP address of the Kerberos client that requested the service ticket.                                                                                          |
|                         | `Advertized Etypes`             | The encryption types the **client says it supports** (in the TGS-REQ packet). Helps detect legacy/RC4-only clients.                                           |
| **Additional Info**     | `Ticket Encryption Type`        | Encryption algorithm the KDC **used for the service ticket**. If the target account lacks encryption config, KDC will **default to RC4**.                     |
|                         | `Session Encryption Type`       | Encryption algorithm used to **protect the session key** shared between the client and service. Defaults to AES if advertised and supported (since Nov 2022). |

---

## üîê Introduction ‚Äì Kerberos Encryption Algorithms on Domain Controllers

In Active Directory environments, Kerberos is the default authentication protocol, responsible for issuing and validating tickets between users, services, and domain controllers (DCs). These tickets are protected using encryption algorithms that evolve over time to address vulnerabilities.

Each Kerberos ticket involves two key components:

The ticket itself, encrypted with a key known only to the KDC and the target service (or krbtgt for TGTs)

The session key, shared securely with the client

The encryption algorithm selected depends on what both sides support. Over time, weak or broken encryption types like DES and RC4 have been deprecated in favor of AES-based standards.

Here are commonly seen Kerberos encryption types on Windows:

| Encryption Type                        | Hex Value       | Status                                 |
| -------------------------------------- | --------------- | -------------------------------------- |
| DES-CBC-CRC / DES-CBC-MD5              | `0x1` / `0x2`   | **Deprecated and insecure** ‚ùå          |
| RC4-HMAC                               | `0x4`           | Weak / legacy compatibility ‚ö†Ô∏è         |
| AES128-CTS-HMAC-SHA1-96                | `0x8`           | Strong (default since 2008+) ‚úÖ         |
| AES256-CTS-HMAC-SHA1-96                | `0x10`          | Strong (default since 2008+) ‚úÖ         |
| AES128/256-CTS-HMAC-SHA2-\* (optional) | `0x11` / `0x12` | Used in newer environments ‚úÖ           |
| `0x20` and beyond                      | varies          | Reserved / undocumented / not standard |

üîê Microsoft recommends disabling DES and RC4, and ensuring AES is used exclusively wherever possible. This reduces the risk of ticket spoofing, key cracking, and "Kerberoasting" attacks.

Auditing which encryption types are supported (via AD attributes) and used (via Kerberos events) is a critical step toward hardening your identity infrastructure.

### üìé Understanding msDS-SupportedEncryptionTypes

The msDS-SupportedEncryptionTypes attribute is a bitmask stored on computer, user, and trust objects in Active Directory. It defines which encryption types the object can use to accept or request Kerberos tickets.

This is not a list of what the KDC will issue, but rather what the object is capable of using. For service accounts, it directly impacts the encryption of service tickets.

When not set, systems fall back to default behavior:

On DCs, the KDC defaults to RC4, unless AES is configured

On clients, the encryption used depends on local policy/GPO settings

Here are some examples of msDS-SupportedEncryptionTypes values and what they mean:

| Value (Hex) | Meaning                          | Interpretation                     |
| ----------- | -------------------------------- | ---------------------------------- |
| `0x18`      | AES128 (`0x8`) + AES256 (`0x10`) | ‚úÖ Strong AES only                  |
| `0x1C`      | AES128 + AES256 + `0x4` (RC4)    | ‚ö†Ô∏è AES preferred, but RC4 allowed  |
| `0x1F`      | AES128 + AES256 + RC4 + DES      | ‚ùå Weak & legacy algorithms enabled |

üí° Best practice:

Apply this attribute via GPO using:

Computer Configuration > Policies > Windows Settings > Security Settings > Local Policies > Security Options >
‚ÄúNetwork security: Configure encryption types allowed for Kerberos‚Äù

This ensures consistent enforcement across domain-joined systems, and automatically updates the attribute in AD.
---

## üßæ Phase 1 ‚Äì Reporting on Kerberos Encryption Configuration of Domain Controllers

The first step in securing Kerberos encryption across an Active Directory forest is to identify what encryption algorithms are currently enabled on each Domain Controller. This is done by querying the msDS-SupportedEncryptionTypes attribute for all DCs across all domains in the forest.

The PowerShell script below performs this task by:

- Iterating over all domains in the forest
- Querying each Domain Controller‚Äôs computer object
- Decoding the bitmask of supported encryption algorithms using a predefined map
- Flagging each DC with a vulnerability level based on known risks:
- Level 2 ‚Üí DES algorithms are enabled (DES-CBC-CRC, DES-CBC-MD5)
- Level 3 ‚Üí AES is not supported (no AES128 or AES256)
- Level 4 ‚Üí RC4 is enabled (RC4-HMAC)
- OK ‚Üí Only AES is enabled

This gives administrators a clear view of which DCs are misconfigured and potentially exposing the environment to cryptographic weaknesses.

Below is the script used to perform this forest-wide assessment:

‚úÖ Prerequisites :

Before running the Kerberos encryption audit script across your forest, make sure the following prerequisites are met:

- PowerShell Environment : Windows PowerShell 5.1 or PowerShell 7+
- Run from a domain-joined machine (management server, workstation, or Domain Controller)
- Required Modules : Active Directory PowerShell module
- Permissions : The script must be executed by an account that has read access to all domains and DC computer objects
- Network Requirements : The machine running the script must be able to resolve and connect to all Domain Controllers via: DNS, LDAP / RPC (default ports: 389, 135)
- Firewall rules must allow LDAP/LDAPs queries and remote AD object resolution across domains


```powershell
# Define encryption algorithm bitmask values
$EncryptionTypesMap = @{
    "DES-CBC-CRC"              = 0x1
    "DES-CBC-MD5"              = 0x2
    "RC4-HMAC"                 = 0x4
    "AES128-CTS-HMAC-SHA1-96" = 0x8
    "AES256-CTS-HMAC-SHA1-96" = 0x10
    "Future encryption types" = 0x20
}

# Initialize result array
$results = @()

# Get all domains in the forest
$forest = [System.DirectoryServices.ActiveDirectory.Forest]::GetCurrentForest()
$domains = $forest.Domains

foreach ($domain in $domains) {
    Write-Host "`nüîç Domain: $($domain.Name)" -ForegroundColor Cyan

    # Connect to domain context
    $domainContext = New-Object System.DirectoryServices.ActiveDirectory.DirectoryContext('Domain', $domain.Name)
    $domainDCs = [System.DirectoryServices.ActiveDirectory.DomainController]::FindAll($domainContext)

    foreach ($dc in $domainDCs) {
        $dcName = $dc.Name.Split(".")[0]  # NetBIOS name
        try {
            # Get the msDS-SupportedEncryptionTypes attribute
            $adComputer = Get-ADComputer -Server $domain.Name -Identity $dcName -Properties msDS-SupportedEncryptionTypes
            $encTypes = $adComputer.'msDS-SupportedEncryptionTypes'

            if (-not $encTypes) {
                $enabledAlgos = "Not Set (defaults to RC4)"
                $level = "Level 4 (RC4 fallback)"
            } else {
                $enabledAlgosList = (
                    $EncryptionTypesMap.GetEnumerator() | Where-Object {
                        ($encTypes -band $_.Value)
                    } | ForEach-Object {
                        $_.Key
                    }
                )
                $enabledAlgos = $enabledAlgosList -join ', '

                # Determine vulnerability level
                if ($enabledAlgosList -contains "DES-CBC-CRC" -or $enabledAlgosList -contains "DES-CBC-MD5") {
                    $level = "Level 2 (DES enabled)"
                } elseif (-not ($enabledAlgosList -contains "AES128-CTS-HMAC-SHA1-96" -or $enabledAlgosList -contains "AES256-CTS-HMAC-SHA1-96")) {
                    $level = "Level 3 (no AES)"
                } elseif ($enabledAlgosList -contains "RC4-HMAC") {
                    $level = "Level 4 (RC4 enabled)"
                } else {
                    $level = "OK"
                }
            }

            # Add to results
            $results += [PSCustomObject]@{
                Domain                   = $domain.Name
                DCName                   = $dcName
                FQDN                     = $dc.Name
                SupportedEncryptionTypes = if ($encTypes) { "0x{0:X}" -f $encTypes } else { "Not Set" }
                EnabledAlgorithms        = $enabledAlgos
                VulnerabilityLevel       = $level
            }
        } catch {
            Write-Warning "‚ùå Error for $dcName in $($domain.Name): $_"
        }
    }
}

# Output results
$results | Format-Table -AutoSize
# Optional: export to CSV
# $results | Export-Csv "Kerberos_Encryption_Forest_Audit.csv" -NoTypeInformation

```

Example :

![](assets/Weak%20supported%20encryption%20algorithms%20on%20DCs/2025-05-05-14-52-18.png)


---

## üßæ Phase 2 ‚Äì Analyzing Kerberos Ticket Usage Across Domain Controllers for impact

Now that we know what encryption algorithms are configured on each Domain Controller via the msDS-SupportedEncryptionTypes attribute, the next step is to verify what encryption algorithms are actually being used in practice.
Each time a Kerberos ticket is issued‚Äîeither a Ticket Granting Ticket (TGT) or a Service Ticket (TGS)‚Äîan event is logged in the Security event log of the issuing Domain Controller:

- Event ID 4768 ‚Äì A Kerberos TGT (AS-REQ) was issued
- Event ID 4769 ‚Äì A service ticket (TGS-REQ) was issued

Both events include a field called TicketEncryptionType, which contains a numeric code representing the encryption algorithm used to protect that ticket.
By collecting and analyzing these logs across all DCs, administrators can:

- Identify legacy systems still requesting weak encryption (e.g., DES, RC4)
- Confirm whether only AES-based encryption is used in production
- Pinpoint specific clients or services that would break if legacy encryption is disabled

This practical insight is crucial before enforcing a hardening policy‚Äîespecially in large or heterogeneous environments.


üß± Prerequisites for Kerberos Ticket Analysis

To successfully analyze Kerberos encryption usage via the Security event logs, Kerberos auditing must be enabled on all Domain Controllers.
Make sure the following subcategories are enabled:
- Audit Kerberos Authentication Service (for TGT issuance ‚Äì Event ID 4768)
- Audit Kerberos Service Ticket Operations (for service tickets ‚Äì Event ID 4769)


üìã Kerberos Event ID Reference

| Event ID | Description                        | Purpose                                | Triggered When                                  |
| -------- | ---------------------------------- | -------------------------------------- | ----------------------------------------------- |
| **4768** | Kerberos Authentication Service    | TGT (Ticket Granting Ticket) is issued | A user or computer authenticates to the domain  |
| **4769** | Kerberos Service Ticket Operations | TGS (Service Ticket) is issued         | A client accesses a service secured by Kerberos |

Both events include the TicketEncryptionType field, which can be extracted to determine which encryption algorithm was used to secure the ticket (e.g., AES, RC4, DES).


* Powershell Script :
--> Adapt the script with a list of DC that your want to query + change the timeline according to your needs

```powershell
# Mapping of encryption type codes to names
$encMap = @{
    0x1  = "DES-CBC-CRC"
    0x2  = "DES-CBC-MD5"
    0x3  = "DES-CBC-MD4"
    0x4  = "RC4-HMAC"
    0x8  = "AES128-CTS-HMAC-SHA1-96"
    0x10 = "AES256-CTS-HMAC-SHA1-96"
    0x11 = "AES128-CTS-HMAC-SHA256-128"
    0x12 = "AES256-CTS-HMAC-SHA384-192"
    0x17 = "Future types"
}

# üìã Manually defined list of DCs (FQDNs or hostnames)
$DCList = @(
    "MyDC1.contoso.com",
    "MyDC2.child.contoso.com"
)

# Results container
$results = @()

foreach ($dc in $DCList) {
    Write-Host "`nüì° Querying $dc..." -ForegroundColor Yellow

    try {
        $events = Get-WinEvent -ComputerName $dc -FilterHashtable @{
            LogName   = 'Security'
            Id        = @(4768, 4769)
            StartTime = (Get-Date).AddHours(-1)
        } -MaxEvents 500 -ErrorAction Stop

        foreach ($event in $events) {
            $xml = [xml]$event.ToXml()
            $etypeNode = $xml.Event.EventData.Data | Where-Object { $_.Name -eq 'TicketEncryptionType' }

            if ($etypeNode) {
                $etype = [int]$etypeNode.'#text'
                $etypeHex = '0x{0:X}' -f $etype

                if ($encMap.ContainsKey($etype)) {
                    $etypeLabel = $encMap[$etype]
                } else {
                    $etypeLabel = "Unknown ($etypeHex)"
                }

                $results += [PSCustomObject]@{
                    DC         = $dc
                    EventID    = $event.Id
                    EncHex     = $etypeHex
                    Encryption = $etypeLabel
                    Time       = $event.TimeCreated
                }
            }
        }
    } catch {
            Write-Warning ("‚ùå Failed to read events from {0}: {1}" -f $dc, $_)
    }
}

# Group and summarize encryption types used
$summary = $results | Group-Object DC, Encryption | Select-Object Name, Count
$summary | Format-Table -AutoSize

# Optional export
# $results | Export-Csv "Kerberos_Usage_SelectedDCs.csv" -NoTypeInformation
# $summary | Export-Csv "Kerberos_Usage_SelectedDCs_Summary.csv" -NoTypeInformation

```