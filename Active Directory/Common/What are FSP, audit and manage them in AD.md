---
title: "Audit and delete Foreign Security Principal"
date: 2025-05-12
---

# Introduction to Foreign Security Principals (FSPs)

In Active Directory (AD), a **Foreign Security Principal (FSP)** is an object of class `foreignSecurityPrincipal` that represents a security principal (user, group, or computer) from a **trusted external domain or forest**.

FSPs are created **automatically** by the system whenever an external security principal is added to a group within the local domain. Since objects from other domains cannot be directly stored in a local domain's group membership, FSPs act as **placeholders** that carry only the **SID (Security Identifier)** of the external object.

> ⚠️ FSPs do **not** contain user attributes or metadata — they are SID-based stubs that allow AD to maintain group membership and ACL references to foreign objects.

### Common scenarios where FSPs are created

- A user from `DomainB` is added to a security group in `DomainA`.
- A group from a trusted forest is added to a universal group in your forest.
- A cross-forest or cross-domain migration involves group membership preservation.

### Key characteristics

- Class: `foreignSecurityPrincipal`
- Resides in: `CN=ForeignSecurityPrincipals,DC=yourdomain,DC=com`
- Created only when needed (e.g., group membership)
- Resolved automatically via trust relationships and SID lookup

### 🛠️ Purpose

FSPs enable:

- **Group-based access control** across domains or forests.
- **SID resolution** for external identities added to ACLs.
- Cross-domain **authorization** in trusted environments.

While often invisible to administrators, FSPs play a critical role in preserving **security context** and **access continuity** in hybrid or multi-domain AD architectures.



# How and When Foreign Security Principals Are Created

Foreign Security Principals (FSPs) are not created manually — they are automatically generated by Active Directory under specific circumstances involving cross-domain or cross-forest group memberships.

### When does Active Directory create an FSP?

An FSP is created **when a security principal from an external domain or forest is added to a group within the local domain**. The object is stored in the special container:

```
CN=ForeignSecurityPrincipals,DC=yourdomain,DC=com
```

This container holds all FSPs as `foreignSecurityPrincipal` objects, each named after the **SID** of the external principal.

---

### Practical examples

#### Example 1: Adding a user from another domain

You have a trust between `CORP.local` and `FABRIKAM.local`.

If you run the following:

```powershell
Add-ADGroupMember -Identity "LocalGroup" -Members "FABRIKAM\Alice"
```

Active Directory will:

1. Create a `foreignSecurityPrincipal` object in `CN=ForeignSecurityPrincipals,...`
2. Use the SID of `FABRIKAM\Alice` to represent her in the group `LocalGroup`
3. Resolve the name to `FABRIKAM\Alice` if the trust is healthy

---

#### Example 2: Cross-forest group nesting

You add a **group** from ForestB into a **universal group** in ForestA:

```powershell
Add-ADGroupMember -Identity "UniversalGroup" -Members "ForestB\Domain Users"
```

The same process applies: an FSP is created for the group, allowing AD to manage nested memberships across forests.

---

### FSP re-creation

If an FSP object is **deleted**, but the SID is still referenced in a group or ACL, **Active Directory may recreate it** automatically on demand (e.g., during a group expansion or ACL resolution), as long as:

- The SID is still valid
- The trust still exists
- The object on the source domain is reachable

> 💡 This makes FSPs *somewhat ephemeral*, but not without risk — deleting them blindly can cause name resolution issues or break access scenarios.

---

### Summary

| Condition                                      | FSP Created? | Auto-Recreated if Deleted? |
|-----------------------------------------------|--------------|-----------------------------|
| Add external user to a local group            | ✅ Yes       | ✅ If trust and SID remain  |
| Add external group to a local group           | ✅ Yes       | ✅ If still referenced      |
| Trust is broken or object no longer exists    | ❌ No        | ❌ Not recreated            |


# Auditing Foreign Security Principal (FSP) Usage in Active Directory

Before removing any Foreign Security Principals (FSPs), it is critical to assess their current usage within the Active Directory (AD) environment.

This chapter outlines how to:
- Identify existing FSPs
- Check if they are members of AD groups
- Determine whether they are referenced in Access Control Lists (ACLs)
- Verify if they can still be resolved to a valid identity

---

## Step 1 – List All FSP Objects

You can list all FSPs with the following PowerShell command:

```powershell
Get-ADObject -Filter 'ObjectClass -eq "foreignSecurityPrincipal"' -Properties Name | 
Select-Object Name, DistinguishedName
```

This retrieves all FSP objects stored under:
```
CN=ForeignSecurityPrincipals,DC=yourdomain,DC=com
```

---

## Step 2 – Find Group Memberships

To determine where each FSP is used as a group member:

```powershell
Get-ADObject -Filter 'ObjectClass -eq "foreignSecurityPrincipal"' | ForEach-Object {
    $fsp = $_
    Get-ADGroup -Filter * -Properties Members | Where-Object {
        $_.Members -contains $fsp.DistinguishedName
    } | Select-Object Name, DistinguishedName
}
```

This helps identify **active usage** of FSPs in group memberships.

---

## Step 3 – Check ACL References

To find FSP SIDs in file system ACLs:

```powershell
icacls C:\SharedFolder /T | findstr "S-1-5-21"
```

Or using PowerShell to parse SIDs:

```powershell
Get-ChildItem -Recurse "C:\SharedFolder" | ForEach-Object {
    Get-Acl $_.FullName
} | Where-Object {
    $_.Access.IdentityReference -match "^S-1-5-21"
}
```

Use [Sysinternals' AccessChk](https://learn.microsoft.com/en-us/sysinternals/downloads/accesschk) to detect object-level permissions across services, registry, and more.

---

## Step 4 – Resolve FSP SIDs

To determine whether a FSP can still be resolved:

```powershell
$fspSID = "S-1-5-21-1234567890-2345678901-3456789012-1234"
$sid = New-Object System.Security.Principal.SecurityIdentifier($fspSID)
try {
    $ntAccount = $sid.Translate([System.Security.Principal.NTAccount])
    Write-Host "Resolved to: $ntAccount"
} catch {
    Write-Host "SID $fspSID could not be resolved."
}
```

If a SID cannot be resolved, it may be a candidate for removal — but only **after confirming** it is not actively used.

---

## ✅ Summary

| Checkpoint             | Purpose                                    | Safe to Delete? |
|------------------------|--------------------------------------------|------------------|
| Listed in group        | Still used in access control               | ❌ No            |
| Not a group member     | Possibly unused                            | ✅ Possibly      |
| Appears in ACL         | May affect file or object access           | ❌ No            |
| SID cannot be resolved | Broken trust or deleted object             | ⚠️ With caution  |

> Always perform a full backup or test in staging before deleting FSPs.


# Safe Removal of Foreign Security Principals (FSPs)

After auditing FSPs in your environment, you may find some that are unused or no longer resolvable. This chapter provides guidance on safely removing these FSPs from Active Directory (AD), while avoiding access disruption.

---

## Key Considerations Before Deletion

- Deleting an FSP **does not automatically remove** its SID from group memberships or ACLs.
- If the SID is still in use, **AD may recreate the FSP** automatically (provided the trust still exists and the object is valid).
- If the SID cannot be resolved and is not referenced, the FSP may be safely deleted.

---

## Step-by-Step Safe Deletion Process

### 1. Confirm the FSP is not a group member

Ensure the FSP is not a current member of any AD group (see Chapter 3, Step 2).

### 2. Confirm the SID is not in any ACL

Validate that no filesystem, GPO, registry, or object permissions are assigned to the FSP’s SID (see Chapter 3, Step 3).

### 3. Check SID resolution

Attempt to translate the SID to an NTAccount. If it fails, the FSP may represent a deleted or unreachable object.

```powershell
$sid = New-Object System.Security.Principal.SecurityIdentifier("S-1-5-21-...")
$sid.Translate([System.Security.Principal.NTAccount])
```

### 4. Backup and document

- Export the list of FSPs and group memberships before deletion.
- Create a snapshot or system state backup for rollback.

---

## Deleting Unused FSPs

Use the following PowerShell to remove a specific FSP:

```powershell
Get-ADObject -LDAPFilter '(objectClass=foreignSecurityPrincipal)' -SearchBase 'CN=ForeignSecurityPrincipals,DC=yourdomain,DC=com' |
Where-Object { $_.Name -eq 'S-1-5-21-...' } |
Remove-ADObject -Confirm:$true
```

To bulk-delete **only orphaned and unresolved** FSPs:

```powershell
Get-ADObject -Filter 'ObjectClass -eq "foreignSecurityPrincipal"' | ForEach-Object {
    try {
        $null = (New-Object System.Security.Principal.SecurityIdentifier($_.Name)).Translate([System.Security.Principal.NTAccount])
    } catch {
        Write-Host "Deleting unresolved FSP: $($_.Name)"
        $_ | Remove-ADObject -Confirm:$true
    }
}
```

> 🔐 **Always validate each deletion manually in a production environment.**

---

## 🛑 What NOT to do

- ❌ Do not delete all FSPs blindly — many may be auto-recreated or currently used.
- ❌ Do not rely solely on SID resolution failure as a deletion criterion without checking group/ACL references.
- ❌ Do not delete FSPs involved in application roles (SQL, SharePoint, Exchange) without app-level validation.

---

## ✅ Summary

| Action                     | Safe?       | Notes                                  |
|----------------------------|-------------|----------------------------------------|
| Delete FSP not in group    | ✅ Likely    | Verify no ACL reference                |
| Delete unresolved SID only | ⚠️ Caution  | Double-check ACL and app usage         |
| Delete all FSPs blindly    | ❌ No       | Can cause loss of group memberships    |
| Leave unused but resolvable FSP | ✅ Optional | No harm in leaving unused ones        |


# Strategic Recommendations for Managing Foreign Security Principals

Managing Foreign Security Principals (FSPs) in a secure and scalable way is especially important in environments with multiple domains, forests, or trust relationships. This final chapter provides best practices to help maintain control and reduce risk.

---

## 1. Design Trusts with Purpose

- Avoid unnecessary forest trusts if cross-domain access is not needed.
- Limit the scope of trusts (e.g., use selective authentication).
- Regularly review and audit trust relationships.

---

## 2. Control Cross-Domain Group Memberships

- Restrict who can add external users or groups to local domain groups.
- Use **role-based access control (RBAC)** to enforce strict group ownership and delegation models.
- Prefer assigning **local users** over foreign principals when feasible.

---

## 3. Implement a Regular FSP Audit Routine

- Schedule periodic audits of `CN=ForeignSecurityPrincipals` container.
- Script group membership checks for all FSPs.
- Track SID resolution failures over time to detect decommissioned external objects.

---

## 4. Document and Monitor FSP Usage

- Keep an inventory of valid FSPs, their source domain, and associated group memberships.
- Monitor changes using AD auditing or a SIEM.
- Tag critical FSPs (e.g., used in Exchange/SQL/SharePoint) and exclude them from cleanup scripts.

---

## 5. Test Deletion in a Safe Environment

- Always test deletion scenarios in a lab or staging domain.
- Validate SID recreation behavior under various trust and membership configurations.
- Create backups and export group memberships before applying cleanup actions.

---

## ✅ Summary of Best Practices

| Recommendation                            | Benefit                             |
|------------------------------------------|-------------------------------------|
| Limit cross-domain membership            | Reduces attack surface              |
| Audit FSPs regularly                     | Identifies stale or unused entries  |
| Use RBAC for group management            | Ensures accountability              |
| Avoid blind FSP deletion                 | Prevents accidental access loss     |
| Track SID resolution status              | Detects broken trust relationships  |

> **Goal**: Maintain clean, resolvable, and purposeful FSPs to ensure secure interoperability across domains.

