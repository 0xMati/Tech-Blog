---
title: "Audit and delete Foreign Security Principal"
date: 2025-05-12
---

# 🧩 Introduction to Foreign Security Principals (FSPs)

In Active Directory (AD), a **Foreign Security Principal (FSP)** is an object of class `foreignSecurityPrincipal` that represents a security principal (user, group, or computer) from a **trusted external domain or forest**.

FSPs are created **automatically** by the system whenever an external security principal is added to a group within the local domain. Since objects from other domains cannot be directly stored in a local domain's group membership, FSPs act as **placeholders** that carry only the **SID (Security Identifier)** of the external object.

> ⚠️ FSPs do **not** contain user attributes or metadata — they are SID-based stubs that allow AD to maintain group membership and ACL references to foreign objects.

### ✅ Common scenarios where FSPs are created

- A user from `DomainB` is added to a security group in `DomainA`.
- A group from a trusted forest is added to a universal group in your forest.
- A cross-forest or cross-domain migration involves group membership preservation.

### 🔍 Key characteristics

- Class: `foreignSecurityPrincipal`
- Resides in: `CN=ForeignSecurityPrincipals,DC=yourdomain,DC=com`
- Created only when needed (e.g., group membership)
- Resolved automatically via trust relationships and SID lookup

### 🛠️ Purpose

FSPs enable:

- **Group-based access control** across domains or forests.
- **SID resolution** for external identities added to ACLs.
- Cross-domain **authorization** in trusted environments.

While often invisible to administrators, FSPs play a critical role in preserving **security context** and **access continuity** in hybrid or multi-domain AD architectures.



# 🏗️ How and When Foreign Security Principals Are Created

Foreign Security Principals (FSPs) are not created manually — they are automatically generated by Active Directory under specific circumstances involving cross-domain or cross-forest group memberships.

### 🧪 When does Active Directory create an FSP?

An FSP is created **when a security principal from an external domain or forest is added to a group within the local domain**. The object is stored in the special container:

```
CN=ForeignSecurityPrincipals,DC=yourdomain,DC=com
```

This container holds all FSPs as `foreignSecurityPrincipal` objects, each named after the **SID** of the external principal.

---

### 🧷 Practical examples

#### ✅ Example 1: Adding a user from another domain

You have a trust between `CORP.local` and `FABRIKAM.local`.

If you run the following:

```powershell
Add-ADGroupMember -Identity "LocalGroup" -Members "FABRIKAM\Alice"
```

Active Directory will:

1. Create a `foreignSecurityPrincipal` object in `CN=ForeignSecurityPrincipals,...`
2. Use the SID of `FABRIKAM\Alice` to represent her in the group `LocalGroup`
3. Resolve the name to `FABRIKAM\Alice` if the trust is healthy

---

#### ✅ Example 2: Cross-forest group nesting

You add a **group** from ForestB into a **universal group** in ForestA:

```powershell
Add-ADGroupMember -Identity "UniversalGroup" -Members "ForestB\Domain Users"
```

The same process applies: an FSP is created for the group, allowing AD to manage nested memberships across forests.

---

### 🔄 FSP re-creation

If an FSP object is **deleted**, but the SID is still referenced in a group or ACL, **Active Directory may recreate it** automatically on demand (e.g., during a group expansion or ACL resolution), as long as:

- The SID is still valid
- The trust still exists
- The object on the source domain is reachable

> 💡 This makes FSPs *somewhat ephemeral*, but not without risk — deleting them blindly can cause name resolution issues or break access scenarios.

---

### 🔐 Summary

| Condition                                      | FSP Created? | Auto-Recreated if Deleted? |
|-----------------------------------------------|--------------|-----------------------------|
| Add external user to a local group            | ✅ Yes       | ✅ If trust and SID remain  |
| Add external group to a local group           | ✅ Yes       | ✅ If still referenced      |
| Trust is broken or object no longer exists    | ❌ No        | ❌ Not recreated            |


# 🔎 Auditing Foreign Security Principal (FSP) Usage in Active Directory

Before removing any Foreign Security Principals (FSPs), it is critical to assess their current usage within the Active Directory (AD) environment.

This chapter outlines how to:
- Identify existing FSPs
- Check if they are members of AD groups
- Determine whether they are referenced in Access Control Lists (ACLs)
- Verify if they can still be resolved to a valid identity

---

## 📋 Step 1 – List All FSP Objects

You can list all FSPs with the following PowerShell command:

```powershell
Get-ADObject -Filter 'ObjectClass -eq "foreignSecurityPrincipal"' -Properties Name | 
Select-Object Name, DistinguishedName
```

This retrieves all FSP objects stored under:
```
CN=ForeignSecurityPrincipals,DC=yourdomain,DC=com
```

---

## 👥 Step 2 – Find Group Memberships

To determine where each FSP is used as a group member:

```powershell
Get-ADObject -Filter 'ObjectClass -eq "foreignSecurityPrincipal"' | ForEach-Object {
    $fsp = $_
    Get-ADGroup -Filter * -Properties Members | Where-Object {
        $_.Members -contains $fsp.DistinguishedName
    } | Select-Object Name, DistinguishedName
}
```

This helps identify **active usage** of FSPs in group memberships.

---

## 🔐 Step 3 – Check ACL References

To find FSP SIDs in file system ACLs:

```powershell
icacls C:\SharedFolder /T | findstr "S-1-5-21"
```

Or using PowerShell to parse SIDs:

```powershell
Get-ChildItem -Recurse "C:\SharedFolder" | ForEach-Object {
    Get-Acl $_.FullName
} | Where-Object {
    $_.Access.IdentityReference -match "^S-1-5-21"
}
```

Use [Sysinternals' AccessChk](https://learn.microsoft.com/en-us/sysinternals/downloads/accesschk) to detect object-level permissions across services, registry, and more.

---

## 🧠 Step 4 – Resolve FSP SIDs

To determine whether a FSP can still be resolved:

```powershell
$fspSID = "S-1-5-21-1234567890-2345678901-3456789012-1234"
$sid = New-Object System.Security.Principal.SecurityIdentifier($fspSID)
try {
    $ntAccount = $sid.Translate([System.Security.Principal.NTAccount])
    Write-Host "Resolved to: $ntAccount"
} catch {
    Write-Host "SID $fspSID could not be resolved."
}
```

If a SID cannot be resolved, it may be a candidate for removal — but only **after confirming** it is not actively used.

---

## ✅ Summary

| Checkpoint             | Purpose                                    | Safe to Delete? |
|------------------------|--------------------------------------------|------------------|
| Listed in group        | Still used in access control               | ❌ No            |
| Not a group member     | Possibly unused                            | ✅ Possibly      |
| Appears in ACL         | May affect file or object access           | ❌ No            |
| SID cannot be resolved | Broken trust or deleted object             | ⚠️ With caution  |

> Always perform a full backup or test in staging before deleting FSPs.

